parameters:
- name: tenant
  displayName: Purge analytics data on API Gateway stages in which tenant?
  type: string
  default: playground
  values:
  - playground
  - realworld
- name: target_types
  displayName: Purge analytics data on which API Gateway stages?
  type: object
  default:
  - CONFIG
  - BUILD
  - DEV_INT
  - DEV_EXT
  - STAGE_INT
  - STAGE_EXT
  - PROD_INT
  - PROD_EXT

stages:
- ${{ each targetType in parameters.target_types }}:
  - stage: ${{ targetType }}
    variables:
      targetType: ${{ targetType }}
    jobs:
    - job: Purge_Data_on_${{ targetType }}
      variables:
      - template: /${{parameters.tenant}}/variables/${{variables.targetType}}/variables-template.yml
      pool:
        name: 'vmssagentpool'
        vmImage: 'ubuntu-latest'
      steps:
      - checkout: self
        submodules: "true"
        persistCredentials: "true"
      - template: /pipelines/api-purge-data-template.yml  # Template reference
        parameters:
          environment: $(environment)
          type: ${{ targetType }}
          tenant: ${{parameters.tenant}}