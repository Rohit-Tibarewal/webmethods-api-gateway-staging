parameters:
- name: template
  type: string
- name: parameters
  type: object
- name: stages
  type: object
  default:
  - name: DESIGN
    is_design_stage: true
    instances:
    - DESIGN
  - name: BUILD
    is_build_stage: true
    instances:
    - BUILD_01
    - BUILD_02
    - BUILD_03
    - BUILD_04
    - BUILD_05
    - BUILD_06
    - BUILD_07
  - name: DEV_INT
    instances:
    - DEV_INT
  - name: DEV_EXT
    instances:
    - DEV_EXT
  - name: TEST_INT
    instances:
    - TEST_INT
  - name: TEST_EXT
    instances:
    - TEST_EXT
  - name: PROD_INT
    configure_haft: true
    instances:
    - PROD_INT_01
    - PROD_INT_02
  - name: PROD_EXT
    configure_haft: true
    instances:
    - PROD_EXT_01
    - PROD_EXT_02
- name: build_instances_mapping
  type: object
  default:
    DESIGN: BUILD_01
    DEV_INT: BUILD_02
    DEV_EXT: BUILD_03
    TEST_INT: BUILD_04
    TEST_EXT: BUILD_05
    PROD_INT: BUILD_06
    PROD_EXT: BUILD_07
- name: api_project
- name: environment_set
- name: selected_target
- name: selected_stage
- name: build_instance
  type: string
  default: Default Mapping
- name: eligible_targets
  type: object

stages:
- template: ${{parameters.template}}
  parameters:
    ${{ each stage in parameters.stages }}:
      ${{ if stage.is_design_stage }}:
        design_stage: ${{stage}}
      ${{ if stage.is_build_stage }}:
        build_stage: ${{stage}}
        ${{ if containsValue(stage.instances, parameters.build_instance) }}:
          build_instances_mapping:
            DESIGN: ${{parameters.build_instance}}
            DEV_INT: ${{parameters.build_instance}}
            DEV_EXT: ${{parameters.build_instance}}
            TEST_INT: ${{parameters.build_instance}}
            TEST_EXT: ${{parameters.build_instance}}
            PROD_INT: ${{parameters.build_instance}}
            PROD_EXT: ${{parameters.build_instance}}
        ${{ else }}:
          build_instances_mapping: ${{parameters.build_instances_mapping}}
    target_stages:
    - ${{ each stage in parameters.stages }}:
      - ${{ if not(stage.is_build_stage) }}:
        - ${{stage}}
    all_stages: # ${{parameters.stages}}
    - ${{ each stage in parameters.stages }}:
      - ${{ if eq(parameters.selected_stage, stage.name) }}:
        - ${{stage}}
      - ${{ elseif eq(parameters.selected_stage, 'All') }}:
        - ${{stage}}
      
    # ${{ if eq(parameters.build_instance, 'Default Mapping')}}:
    #   build_instances_mapping: ${{parameters.build_instances_mapping}}
    # ${{ else }}:
    #   build_instances_mapping:
    #     DESIGN: ${{parameters.build_instance}}
    #     DEV_INT: ${{parameters.build_instance}}
    #     DEV_EXT: ${{parameters.build_instance}}
    #     TEST_INT: ${{parameters.build_instance}}
    #     TEST_EXT: ${{parameters.build_instance}}
    #     PROD_INT: ${{parameters.build_instance}}
    #     PROD_EXT: ${{parameters.build_instance}}
    environment_set: ${{parameters.environment_set}}
    deployment_sets:
    - ${{ each eligible_target in parameters.eligible_targets }}:
      - api_projects: # ${{ eligible_target.api_projects }}
        - ${{ each api_project in eligible_target.api_projects }}:
          - ${{ if eq(parameters.api_project, api_project) }}:
            - ${{api_project}}
          - ${{ elseif eq(parameters.api_project, 'All') }}:
            - ${{api_project}}
        targets: # ${{ eligible_target.targets }}
        - ${{ each target in eligible_target.targets }}:
          - ${{ if eq(parameters.selected_target, target) }}:
            - ${{target}}
          - ${{ elseif eq(parameters.selected_target, 'All (including DESIGN)') }}:
            - ${{target}}
          - ${{ elseif and(eq(parameters.selected_target, 'All (execpt DESIGN)'), ne(target, 'DESIGN')) }}:
            - ${{target}}
    ${{ each parameter in parameters.parameters}}:
      ${{parameter.key}}: ${{parameter.value}}