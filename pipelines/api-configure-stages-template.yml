parameters:
- name: tenant
  displayName: Configure API Gateway in which tenant?
  type: string
  default: playground
  values:
  - playground
  - realworld
- name: stages
  displayName: Configure API Gateway in which stages?
  type: object
  default:
  - name: CONFIG
    jobs:
    - name: CONFIG
      pool: vmsspoolagents
      image: ubuntu-latest
  - name: BUILD
    buildjobs:
    - name: BUILD_01
      pool: buildagents
      image: ubuntu-latest
    - name: BUILD_02
      pool: buildagents
      image: ubuntu-latest
    - name: BUILD_03
      pool: buildagents
      image: ubuntu-latest
  - name: DEV_INT
    jobs:
    - name: DEV_INT
      pool: vmsspoolagents
      image: ubuntu-latest
  - name: DEV_EXT
    jobs:
    - name: DEV_EXT
      pool: vmsspoolagents
      image: ubuntu-latest
  - name: STAGE_INT
    jobs:
    - name: STAGE_INT
      pool: vmsspoolagents
      image: ubuntu-latest
  - name: STAGE_EXT
    jobs:
    - name: STAGE_EXT
      pool: vmsspoolagents
      image: ubuntu-latest
  - name: PROD_INT
    jobs:
    - name: PROD_INT_01
      pool: vmsspoolagents
      image: ubuntu-latest
    - name: PROD_INT_02
      pool: vmsspoolagents
      image: ubuntu-latest
    configure_haft_jobs:
    - name: PROD_INT_HAFT
      pool: vmsspoolagents
      image: ubuntu-latest
  - name: PROD_EXT
    jobs:
    - name: PROD_EXT_01
      pool: vmsspoolagents
      image: ubuntu-latest
    - name: PROD_EXT_02
      pool: vmsspoolagents
      image: ubuntu-latest
    configure_haft_jobs:
    - name: PROD_INT_HAFT
      pool: vmsspoolagents
      image: ubuntu-latest

stages:
- ${{ each stage in parameters.stages }}:
  - stage: ${{ stage.name }}
    dependsOn: []
    jobs:
    - ${{ each job in stage.jobs }}:
      - deployment: Configure_API_Gateway_${{ job.name }}
        environment: ${{ job.name }}
        variables:
        - group: ${{parameters.tenant}}_${{ job.name }}_users
        pool:
          name: '${{ job.pool }}'
          vmImage: '${{ job.image }}'
        strategy:
          runOnce:    #rolling, canary are the other strategies that are supported
            deploy:
              steps:
              - checkout: self
                submodules: "true"
                persistCredentials: "true"
              - download: none

    - ${{ each job in stage.buildjobs }}:
      - deployment: Configure_API_Gateway_${{ job.name }}
        environment: ${{ stage.name }}
        variables:
        - group: ${{parameters.tenant}}_${{ job.name }}_users
        pool:
          name: '${{ job.pool }}'
          vmImage: '${{ job.image }}'
          demands: Agent.Name -equals ${{ job.name }}
        strategy:
          runOnce:    #rolling, canary are the other strategies that are supported
            deploy:
              steps:
              - checkout: self
                submodules: "true"
                persistCredentials: "true"
              - download: none

    - ${{ each job in stage.configure_haft_jobs }}:
      - deployment: Configure_HAFT_for_API_Gateway_${{ stage.name }}
        environment: ${{ job.name }}
        pool:
          name: '${{ job.pool }}'
          vmImage: '${{ job.image }}'
        strategy:
          runOnce:    #rolling, canary are the other strategies that are supported
            deploy:
              steps:
              - checkout: self
                submodules: "true"
                persistCredentials: "true"
              - download: none
