parameters:
- name: tenant
  displayName: Configure API Gateway in which tenant?
  type: string
  default: playground
  values:
  - playground
  - realworld
- name: stages
  displayName: Configure API Gateway in which stages?
  type: object
  default:
  - name: CONFIG
    targets: [ "CONFIG" ]
    pool: vmsspoolagents
    image: ubuntu-latest
  - name: BUILD
    targets: [ "BUILD" ]
    pool: vmsspoolagents
    image: ubuntu-latest
  - name: DEV_INT
    targets: [ "DEV_INT" ]
    pool: vmsspoolagents
    image: ubuntu-latest
  - name: DEV_EXT
    targets: [ "DEV_EXT" ]
    pool: vmsspoolagents
    image: ubuntu-latest
  - name: STAGE_INT
    targets: [ "STAGE_INT" ]
    pool: vmsspoolagents
    image: ubuntu-latest
  - name: STAGE_EXT
    targets: [ "STAGE_EXT" ]
    pool: vmsspoolagents
    image: ubuntu-latest
  - name: PROD_INT
    targets: [ "PROD_INT_01", "PROD_INT_02" ]
    pool: vmsspoolagents
    image: ubuntu-latest
  - name: PROD_EXT
    targets: [ "PROD_EXT_01", "PROD_EXT_02" ]
    pool: vmsspoolagents
    image: ubuntu-latest

stages:
- ${{ each stage in parameters.stages }}:
  - stage: ${{ stage.name }}
    dependsOn: []
    jobs:
    - ${{ each target in stage.targets }}:
      - deployment: Configure_API_Gateway_${{ target }}
        environment: ${{ target }}
        variables:
        - template: /${{parameters.tenant}}/variables/${{ target }}/variables-template.yml
        pool:
          name: '${{ stage.pool }}'
          vmImage: '${{ stage.image }}'
        strategy:
          runOnce:    #rolling, canary are the other strategies that are supported
            deploy:
              steps:
              - checkout: self
                submodules: "true"
                persistCredentials: "true"
              - download: none
              - template: /pipelines/api-configure-steps-template.yml
                parameters:
                  environment: $(environment)
                  type: ${{ stage.name }}
                  tenant: ${{parameters.tenant}}
              - bash: echo "##vso[build.addbuildtag]${{target}}"
                displayName: Add build tag