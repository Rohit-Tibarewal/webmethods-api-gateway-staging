# Pipeline for apig staging

trigger: none

parameters:
- name: tenant
  displayName: Deploy API project on API Gateway stages in which tenant?
  type: string
  default: playground
  values:
  - playground
  - realworld
- name: apiProject
  displayName: Deploy which API project?
  type: string

variables:
- name: targetTypes
  value: "DEV_INT,DEV_EXT,STAGE_INT,STAGE_EXT,PROD_INT,PROD_EXT"
- template: /${{parameters.tenant}}/variables/variables-aliases-template.yml
# - template: /${{parameters.tenant}}/variables/variables-artifactory-template.yml

name: $(Date:yyyyMMdd).$(Rev:r)-${{parameters.apiProject}}

stages:
- ${{ each targetType in [ "DEV_INT","DEV_EXT" ]}}:
  - stage: ${{ targetType }}
    variables:
      targetType: ${{ targetType }}
    jobs:
    - job: Build_for_${{ targetType }}
      variables:
      - template: /${{parameters.tenant}}/variables/BUILD/variables-template.yml
      pool:
        name: '$(agent_pool)'
        vmImage: '$(agent_pool_vmImage)'
      steps:
      - checkout: self
        submodules: "true"
        persistCredentials: "true"
      - template: /pipelines/api-build-template.yml  # Template reference
        parameters:
          apiProject: ${{parameters.apiProject}}
          build_environment: $(environment)
          target_type: $(targetType)
          prep_condition: ${{true}}
          test_condition: ${{ ne(variables['targetType'], 'CONFIG') }}
          tenant: ${{parameters.tenant}}
      - template: /pipelines/store-build-template.yml  # Template reference
        parameters:
          target_type: $(targetType)
      # - template: /pipelines/store-build-artifactory-template.yml  # Template reference
      #   parameters:
      #     target_type: $(targetType)

    - job: Deploy_to_API_Gateway_${{ targetType }}
      variables:
      - template: /${{parameters.tenant}}/variables/${{variables.targetType}}/variables-template.yml
      pool:
        name: '$(agent_pool)'
        vmImage: '$(agent_pool_vmImage)'
      steps:
      - checkout: self
        submodules: "true"
        persistCredentials: "true"
      - template: /pipelines/retrieve-build-template.yml  # Template reference
        parameters:
            target_type: $(targetType)
      - template: /pipelines/api-deploy-template.yml  # Template reference
        parameters:
          apiProject: ${{parameters.apiProject}}
          target_environment: $(environment)
          target_type: $(targetType)
          prep_condition: ${{true}}
          test_condition: ${{ ne(variables['targetType'], 'CONFIG') }}
          tenant: ${{parameters.tenant}}
      dependsOn: Build_for_${{ targetType }}
      condition: succeeded()